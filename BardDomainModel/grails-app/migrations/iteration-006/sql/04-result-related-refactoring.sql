
-- Standard Alter Table SQL

ALTER TABLE EXPERIMENT DROP CONSTRAINT CK_EXPERIMENT_EXTRACTION
;
ALTER TABLE EXPERIMENT MODIFY(READY_FOR_EXTRACTION  DEFAULT 'Pending')
;
ALTER TABLE EXPERIMENT ADD CONSTRAINT CK_EXPERIMENT_EXTRACTION
CHECK (ready_for_extraction IN ('Pending', 'Ready', 'Started', 'Complete'))
;
ALTER TABLE RESULT DROP CONSTRAINT CK_RESULT_EXTRACTION
;
ALTER TABLE RESULT DROP (REPLICATE_NO)
;
ALTER TABLE RESULT MODIFY(READY_FOR_EXTRACTION  DEFAULT 'Pending')
;
ALTER TABLE RESULT ADD CONSTRAINT CK_RESULT_EXTRACTION
CHECK (ready_for_extraction IN ('Pending', 'Ready', 'Started', 'Complete'))
;

-- Drop Constraint, Rename and Create Table SQL

ALTER TABLE RESULT_CONTEXT_ITEM DROP CONSTRAINT FK_RESULT_CONTEXT_ITEM_GROUP
;
ALTER TABLE RESULT_CONTEXT_ITEM DROP CONSTRAINT FK_RESULT_CONTEXT_ITEM_RESULT
;
ALTER TABLE RESULT_CONTEXT_ITEM DROP CONSTRAINT FK_R_CONTEXT_ITEM_ATTRIBUTE
;
ALTER TABLE RESULT_CONTEXT_ITEM DROP CONSTRAINT FK_R_CONTEXT_ITEM_EXPERIMENT
;
ALTER TABLE RESULT_CONTEXT_ITEM DROP CONSTRAINT FK_R_CONTEXT_ITEM_VALUE
;
ALTER TABLE RESULT_CONTEXT_ITEM DROP PRIMARY KEY DROP INDEX
;
ALTER TABLE RESULT_CONTEXT_ITEM DROP CONSTRAINT CK_RESULT_CONTEXT_ITEM_QUALFR
;
DROP INDEX FK_R_CONTEXT_ITEM_ATTRIBUTE
;
DROP INDEX FK_R_CONTEXT_ITEM_VALUE
;
DROP INDEX FK_R_CONTEXT_ITEM_QUALIFIER
;
DROP INDEX FK_RESULT_CONTEXT_ITEM_RESULT
;
DROP INDEX FK_RESULT_CONTEXT_ITEM_GROUP
;
DROP INDEX FK_R_CONTEXT_ITEM_EXPERIMENT
;
ALTER TABLE RESULT_CONTEXT_ITEM RENAME TO RESULT_CON_08202012221212000
;
CREATE TABLE RUN_CONTEXT_ITEM
(
    RUN_CONTEXT_ITEM_ID  NUMBER(19)    NOT NULL,
    GROUP_RUN_CONTEXT_ID NUMBER(19)        NULL,
    EXPERIMENT_ID        NUMBER(19)        NULL,
    RESULT_ID            NUMBER(19)        NULL,
    DISCRIMINATOR        VARCHAR2(20)  DEFAULT 'Result' NOT NULL,
    ATTRIBUTE_ID         NUMBER(19)    NOT NULL,
    VALUE_ID             NUMBER(19)        NULL,
    EXT_VALUE_ID         VARCHAR2(60)      NULL,
    QUALIFIER            CHAR(2)           NULL,
    VALUE_NUM            FLOAT(126)        NULL,
    VALUE_MIN            FLOAT(126)        NULL,
    VALUE_MAX            FLOAT(126)        NULL,
    VALUE_DISPLAY        VARCHAR2(500)     NULL,
    VERSION              NUMBER(38)    DEFAULT 0 NOT NULL,
    DATE_CREATED         TIMESTAMP(6)  DEFAULT sysdate NOT NULL,
    LAST_UPDATED         TIMESTAMP(6)      NULL,
    MODIFIED_BY          VARCHAR2(40)      NULL
)
;
COMMENT ON COLUMN RUN_CONTEXT_ITEM.VALUE_DISPLAY IS
'This is not a general text entry field, rather it is an easily displayable text version of the other value columns'
;

-- Insert Data SQL

ALTER SESSION ENABLE PARALLEL DML
;
INSERT INTO RUN_CONTEXT_ITEM(
                     RUN_CONTEXT_ITEM_ID,
                     GROUP_RUN_CONTEXT_ID,
                     EXPERIMENT_ID,
                     RESULT_ID,
                     DISCRIMINATOR,
                     ATTRIBUTE_ID,
                     VALUE_ID,
                     EXT_VALUE_ID,
                     QUALIFIER,
                     VALUE_NUM,
                     VALUE_MIN,
                     VALUE_MAX,
                     VALUE_DISPLAY,
                     VERSION,
                     DATE_CREATED,
                     LAST_UPDATED,
                     MODIFIED_BY
                    )
              SELECT
                     RESULT_CONTEXT_ITEM_ID,
                     GROUP_RESULT_CONTEXT_ID,
                     DECODE(RESULT_ID, NULL, EXPERIMENT_ID, NULL),
                     RESULT_ID,
                     DECODE(RESULT_ID, NULL, 'Experiment', 'Result'),
                     ATTRIBUTE_ID,
                     VALUE_ID,
                     EXT_VALUE_ID,
                     QUALIFIER,
                     VALUE_NUM,
                     VALUE_MIN,
                     VALUE_MAX,
                     VALUE_DISPLAY,
                     VERSION,
                     DATE_CREATED,
                     LAST_UPDATED,
                     MODIFIED_BY
                FROM RESULT_CON_08202012221212000
;
ALTER TABLE RUN_CONTEXT_ITEM LOGGING
;

-- Add Constraint SQL

ALTER TABLE RUN_CONTEXT_ITEM ADD CONSTRAINT PK_RUN_CONTEXT_ITEM
PRIMARY KEY (RUN_CONTEXT_ITEM_ID)
;
ALTER TABLE RUN_CONTEXT_ITEM ADD CONSTRAINT CK_RUN_CONTEXT_ITEM_QUALFR
CHECK (Qualifier IN ('= ', '< ', '<=', '> ', '>=', '<<', '>>', '~ '))
;
ALTER TABLE RUN_CONTEXT_ITEM ADD CONSTRAINT CK_RUN_CONTEXT_ITEM_DISCRIM
CHECK ((discriminator = 'Result' AND result_id IS NOT NULL AND experiment_id IS NULL)
       OR
      (discriminator = 'Experiment' AND result_id IS NULL AND experiment_id IS NOT NULL))
;
ALTER TABLE EXTERNAL_REFERENCE ADD CONSTRAINT CK_PROJECT_EXPERIMENT_NULLS
CHECK ((Project_ID is null and experiment_ID is not null)
 or
(Project_ID is not null and experiment_ID is null))
;

-- Alter Index SQL

CREATE INDEX FK_R_CONTEXT_ITEM_EXPERIMENT
    ON RUN_CONTEXT_ITEM(EXPERIMENT_ID)
;
CREATE INDEX FK_R_CONTEXT_ITEM_RESULT
    ON RUN_CONTEXT_ITEM(RESULT_ID)
;
CREATE INDEX FK_R_CONTEXT_ITEM_QUALIFIER
    ON RUN_CONTEXT_ITEM(QUALIFIER)
;
CREATE INDEX FK_R_CONTEXT_ITEM_VALUE
    ON RUN_CONTEXT_ITEM(VALUE_ID)
;
CREATE INDEX FK_R_CONTEXT_ITEM_ATTRIBUTE
    ON RUN_CONTEXT_ITEM(ATTRIBUTE_ID)
;
CREATE INDEX FK_R_CONTEXT_ITEM_GROUP
    ON RUN_CONTEXT_ITEM(GROUP_RUN_CONTEXT_ID)
;

-- Add Referencing Foreign Keys SQL

ALTER TABLE RUN_CONTEXT_ITEM ADD CONSTRAINT FK_R_CONTEXT_ITEM_GROUP
FOREIGN KEY (GROUP_RUN_CONTEXT_ID)
REFERENCES RUN_CONTEXT_ITEM (RUN_CONTEXT_ITEM_ID)
ENABLE VALIDATE
;
ALTER TABLE RUN_CONTEXT_ITEM ADD CONSTRAINT FK_R_CONTEXT_ITEM_RESULT
FOREIGN KEY (RESULT_ID)
REFERENCES RESULT (RESULT_ID)
ENABLE VALIDATE
;
ALTER TABLE RUN_CONTEXT_ITEM ADD CONSTRAINT FK_R_CONTEXT_ITEM_ATTRIBUTE
FOREIGN KEY (ATTRIBUTE_ID)
REFERENCES ELEMENT (ELEMENT_ID)
ENABLE VALIDATE
;
ALTER TABLE RUN_CONTEXT_ITEM ADD CONSTRAINT FK_R_CONTEXT_ITEM_EXPERIMENT
FOREIGN KEY (EXPERIMENT_ID)
REFERENCES EXPERIMENT (EXPERIMENT_ID)
ENABLE VALIDATE
;
ALTER TABLE RUN_CONTEXT_ITEM ADD CONSTRAINT FK_R_CONTEXT_ITEM_VALUE
FOREIGN KEY (VALUE_ID)
REFERENCES ELEMENT (ELEMENT_ID)
ENABLE VALIDATE
;

RENAME RESULT_CONTEXT_ITEM_ID_SEQ TO RUN_CONTEXT_ITEM_ID_SEQ
;
